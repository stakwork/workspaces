<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pod Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
    .env-var-row {
        display: flex;
        gap: 8px;
        align-items: end;
        margin-bottom: 8px;
    }
    .env-var-row input {
        flex: 1;
    }
    .env-var-row button {
        flex-shrink: 0;
    }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Login to Pod Manager</h3>
                <form id="loginForm">
                    <div class="mb-4">
                        <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Username:</label>
                        <input type="text" id="username" name="username" required
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                        <input type="password" id="password" name="password" required
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div id="loginError" class="mb-4 text-red-500 text-sm hidden"></div>
                    <div class="flex items-center justify-between">
                        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Sign In
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="container mx-auto p-4 hidden">
        <!-- Header with Logout -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Pod Manager</h1>
            <div class="flex items-center space-x-4">
                <span id="userInfo" class="text-gray-600"></span>
                <button id="logoutBtn" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600">
                    Logout
                </button>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="mb-6">
            <nav class="flex space-x-8" aria-label="Tabs">
                <button id="poolsTab" class="tab-button bg-green-500 text-white py-2 px-4 rounded-md">
                    Pod Pools
                </button>
                <button id="usersTab" class="tab-button bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300">
                    Users
                </button>
            </nav>
        </div>

        <!-- Pools Content -->
        <div id="poolsContent" class="hidden">
            <!-- Create Pool Form -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8 hidden">
                <h2 class="text-xl font-semibold mb-4">Create New Pool</h2>
                <form id="createPoolForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="poolName" class="block text-gray-700 mb-2">Pool Name</label>
                            <input type="text" id="poolName" 
                                placeholder="e.g., frontend-dev-pool" 
                                class="w-full p-2 border border-gray-300 rounded-md" required>
                            <p class="text-xs text-gray-500 mt-1">Unique identifier for this pool</p>
                        </div>
                        
                        <div>
                            <label for="minimumVms" class="block text-gray-700 mb-2">Minimum VMs</label>
                            <input type="number" id="minimumVms" min="1" value="1"
                                class="w-full p-2 border border-gray-300 rounded-md" required>
                            <p class="text-xs text-gray-500 mt-1">Minimum number of running pods</p>
                        </div>
                        
                        <div>
                            <label for="poolRepoName" class="block text-gray-700 mb-2">Repository URL</label>
                            <input type="text" id="poolRepoName" 
                                placeholder="e.g., https://github.com/myorg/my-repo" 
                                class="w-full p-2 border border-gray-300 rounded-md" required>
                            <p class="text-xs text-gray-500 mt-1">GitHub repository (URL)</p>
                        </div>
                        
                        <div>
                            <label for="poolBranchName" class="block text-gray-700 mb-2">Branch Name</label>
                            <input type="text" id="poolBranchName" 
                                placeholder="master" value="master"
                                class="w-full p-2 border border-gray-300 rounded-md" required>
                            <p class="text-xs text-gray-500 mt-1">Git branch to clone</p>
                        </div>
                    </div>

                    <div class="mt-6">
                        <label for="poolGithubUsername" class="block text-gray-700 mb-2">GitHub Username</label>
                        <input type="text" id="poolGithubUsername" 
                            placeholder="your-github-username" 
                            class="w-full p-2 border border-gray-300 rounded-md">
                        <p class="text-xs text-gray-500 mt-1">
                            GitHub username associated with the Personal Access Token above.
                        </p>
                    </div>
                    
                    <div class="mt-6">
                        <label for="poolGithubPat" class="block text-gray-700 mb-2">GitHub Personal Access Token</label>
                        <input type="password" id="poolGithubPat" 
                            placeholder="ghp_xxxxxxxxxxxxxxxx" 
                            class="w-full p-2 border border-gray-300 rounded-md">
                        <p class="text-xs text-gray-500 mt-1">
                            <span class="text-red-500">Required for private pool creation.</span> 
                            Create a token with <b>repo</b> access for private repositories.
                        </p>
                    </div>

                    <!-- Environment Variables Section -->
                    <div class="mt-6">
                        <h3 class="text-lg font-medium mb-3">Environment Variables (Optional)</h3>
                        <div id="poolEnvVars" class="space-y-2 mb-4">
                            <div class="env-var-row">
                                <div class="flex-1">
                                    <input type="text" placeholder="Variable name (e.g., NODE_ENV)" 
                                        class="w-full p-2 border border-gray-300 rounded-md env-var-name">
                                </div>
                                <div class="flex-1">
                                    <input type="text" placeholder="Variable value (e.g., development)" 
                                        class="w-full p-2 border border-gray-300 rounded-md env-var-value">
                                </div>
                                <button type="button" class="remove-env-var bg-red-500 text-white py-2 px-3 rounded-md text-sm hover:bg-red-600">
                                    Remove
                                </button>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button type="button" id="addPoolEnvVar" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300">
                                + Add Environment Variable
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            These environment variables will be available in all pods created by this pool.
                        </p>
                    </div>
                    
                    <div class="mt-6">
                        <button type="submit" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600">
                            Create Pool
                        </button>
                    </div>
                </form>
                <div id="createPoolStatus" class="mt-4 hidden"></div>
            </div>

            <!-- Cluster Capacity Info -->
            <div id="capacityInfo" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-blue-800 mb-2">Cluster Capacity</h3>
                <div id="capacityDetails" class="text-sm text-gray-600">
                    <p>Loading capacity information...</p>
                </div>
            </div>
            
            <!-- Pools List -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Pod Pools</h2>
                <div id="poolsList" class="space-y-4">
                    <p class="text-gray-500">Loading pools...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Content -->
    <div id="usersContent" class="hidden">
        <!-- Create User Form -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4">Create New User</h2>
            <form id="createUserForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="newUsername" class="block text-gray-700 mb-2">Username</label>
                        <input type="text" id="newUsername" 
                            placeholder="Enter username" 
                            class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    
                    <div>
                        <label for="newEmail" class="block text-gray-700 mb-2">Email</label>
                        <input type="email" id="newEmail" 
                            placeholder="Enter email" 
                            class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    
                    <div>
                        <label for="newPassword" class="block text-gray-700 mb-2">Password</label>
                        <input type="password" id="newPassword" 
                            placeholder="Enter password (min 6 characters)" 
                            class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">
                        Create User
                    </button>
                </div>
            </form>
            <div id="createUserStatus" class="mt-4 hidden"></div>
        </div>
        
        <!-- Users List -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Users</h2>
            <div id="usersList" class="space-y-4">
                <p class="text-gray-500">Loading users...</p>
            </div>
        </div>
    </div>
    
    <script>
    const API_BASE_URL = '/api';
    let repoCounter = 1;
    let authToken = null;
    let currentUser = null;
    let currentTab = 'pools';

    // Function to load cluster capacity
    async function loadCapacity() {
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/workspaces/capacity`);
            const data = await response.json();
            
            const capacityDetails = document.getElementById('capacityDetails');
            
            if (response.ok) {
                const cluster = data.cluster_resources;
                const workspace = data.workspace_capacity;
                const requirements = data.per_workspace_requirements;
                
                // Determine status color based on capacity
                let statusColor = 'text-green-600';
                let statusText = 'Good capacity available';
                
                if (workspace.max_additional_workspaces <= 2) {
                    statusColor = 'text-red-600';
                    statusText = 'Low capacity - consider scaling cluster';
                } else if (workspace.max_additional_workspaces <= 5) {
                    statusColor = 'text-yellow-600';
                    statusText = 'Moderate capacity available';
                }
                
                capacityDetails.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded p-3 border">
                            <h4 class="font-semibold text-gray-700 mb-2">Resource Usage</h4>
                            <div class="space-y-1">
                                <div class="flex justify-between">
                                    <span>CPU:</span>
                                    <span>${cluster.used_cpu_cores.toFixed(1)} / ${cluster.total_cpu_cores.toFixed(1)} cores</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${(cluster.used_cpu_cores / cluster.total_cpu_cores * 100).toFixed(1)}%"></div>
                                </div>
                                <div class="flex justify-between">
                                    <span>Memory:</span>
                                    <span>${cluster.used_memory_gb.toFixed(1)} / ${cluster.total_memory_gb.toFixed(1)} GB</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${(cluster.used_memory_gb / cluster.total_memory_gb * 100).toFixed(1)}%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded p-3 border">
                            <h4 class="font-semibold text-gray-700 mb-2">Workspace Capacity</h4>
                            <div class="space-y-1">
                                <div class="flex justify-between">
                                    <span>Current Workspaces:</span>
                                    <span class="font-medium">${workspace.current_workspaces}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Additional Capacity:</span>
                                    <span class="font-medium ${statusColor}">${workspace.max_additional_workspaces}</span>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500">
                                    <span>Limited by:</span>
                                    <span class="uppercase">${workspace.limited_by}</span>
                                </div>
                                <div class="${statusColor} text-xs font-medium mt-2">
                                    ${statusText}
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded p-3 border">
                            <h4 class="font-semibold text-gray-700 mb-2">Per Workspace Requirements</h4>
                            <div class="space-y-1">
                                <div class="flex justify-between">
                                    <span>CPU:</span>
                                    <span>${requirements.cpu_cores} cores</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Memory:</span>
                                    <span>${requirements.memory_gb} GB</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-2">
                                    Available: ${cluster.available_cpu_cores.toFixed(1)} CPU, ${cluster.available_memory_gb.toFixed(1)}GB RAM
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-xs text-gray-500 flex justify-between items-center">
                        <span>Last updated: ${new Date().toLocaleString()}</span>
                        <button onclick="loadCapacity()" class="text-blue-600 hover:text-blue-800 underline">
                            Refresh Capacity
                        </button>
                    </div>
                `;
            } else {
                capacityDetails.innerHTML = `
                    <p class="text-red-600">Failed to load capacity information: ${data.error || 'Unknown error'}</p>
                    <button onclick="loadCapacity()" class="text-blue-600 hover:text-blue-800 underline text-sm mt-2">
                        Retry
                    </button>
                `;
            }
        } catch (error) {
            console.error('Error loading capacity:', error);
            if (error.message !== 'Authentication required') {
                document.getElementById('capacityDetails').innerHTML = `
                    <p class="text-red-600">Failed to load capacity information.</p>
                    <button onclick="loadCapacity()" class="text-blue-600 hover:text-blue-800 underline text-sm mt-2">
                        Retry
                    </button>
                `;
            }
        }
    }

    function encodePoolName(poolName) {
        return encodeURIComponent(poolName);
    }

    // Authentication utilities
    class Auth {
        static getToken() {
            return localStorage.getItem('workspace_auth_token');
        }
        
        static setToken(token) {
            localStorage.setItem('workspace_auth_token', token);
            authToken = token;
        }
        
        static removeToken() {
            localStorage.removeItem('workspace_auth_token');
            localStorage.removeItem('workspace_user_info');
            authToken = null;
            currentUser = null;
        }
        
        static getUserInfo() {
            const userInfo = localStorage.getItem('workspace_user_info');
            return userInfo ? JSON.parse(userInfo) : null;
        }
        
        static setUserInfo(userInfo) {
            localStorage.setItem('workspace_user_info', JSON.stringify(userInfo));
            currentUser = userInfo;
        }
        
        static isAuthenticated() {
            const token = this.getToken();
            if (!token) return false;
            
            try {
                // Simple JWT expiration check
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload.exp * 1000 > Date.now();
            } catch (e) {
                return false;
            }
        }
        
        static getAuthHeaders() {
            const token = this.getToken();
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
    });

    function initializeApp() {
        authToken = Auth.getToken();
        currentUser = Auth.getUserInfo();
        
        if (Auth.isAuthenticated()) {
            showMainContent();
            setupTabListeners();
            setupFormListeners();
            switchTab('pools'); // Default to Pod Pools
        } else {
            showLoginModal();
        }
        
        setupAuthListeners();
    }

    function setupAuthListeners() {
        // Login form
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        
        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    }

    function setupTabListeners() {
        document.getElementById('poolsTab').addEventListener('click', () => switchTab('pools'));
        document.getElementById('usersTab').addEventListener('click', () => switchTab('users'));
    }

    function switchTab(tab) {
        currentTab = tab;
        // Update tab buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.className = 'tab-button bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300';
        });

        document.getElementById('poolsContent').classList.add('hidden');
        document.getElementById('usersContent').classList.add('hidden');

        if (tab === 'pools') {
            document.getElementById('poolsTab').className = 'tab-button bg-green-500 text-white py-2 px-4 rounded-md';
            document.getElementById('poolsContent').classList.remove('hidden');
            loadPools();
        } else if (tab === 'users') {
            document.getElementById('usersTab').className = 'tab-button bg-purple-500 text-white py-2 px-4 rounded-md';
            document.getElementById('usersContent').classList.remove('hidden');
            loadUsers();
        }
    }

    function showLoginModal() {
        document.getElementById('loginModal').classList.remove('hidden');
        document.getElementById('mainContent').classList.add('hidden');
    }

    function showMainContent() {
        document.getElementById('loginModal').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        
        if (currentUser) {
            document.getElementById('userInfo').textContent = `Welcome, ${currentUser.username}`;
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const loginError = document.getElementById('loginError');
        
        try {
            const response = await fetch(`${API_BASE_URL}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                Auth.setToken(data.token);
                Auth.setUserInfo(data.user);
                currentUser = data.user;
                
                showMainContent();
                setupTabListeners();
                setupFormListeners();
                switchTab('pools'); // Ensure Pod Pools tab and content is shown after login
                
                // Clear form
                document.getElementById('loginForm').reset();
                loginError.classList.add('hidden');
            } else {
                loginError.textContent = data.error || 'Login failed';
                loginError.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Login error:', error);
            loginError.textContent = 'Login failed. Please try again.';
            loginError.classList.remove('hidden');
        }
    }

    function handleLogout() {
        if (confirm('Are you sure you want to logout?')) {
            Auth.removeToken();
            showLoginModal();
        }
    }

    // Modified fetch function to include auth headers
    async function authenticatedFetch(url, options = {}) {
        const authHeaders = Auth.getAuthHeaders();
        
        const config = {
            ...options,
            headers: {
                ...authHeaders,
                ...options.headers
            }
        };
        
        const response = await fetch(url, config);
        
        // Handle 401 Unauthorized
        if (response.status === 401) {
            Auth.removeToken();
            showLoginModal();
            throw new Error('Authentication required');
        }
        
        return response;
    }

    // Setup form listeners
    function setupFormListeners() {
        document.getElementById('addPoolEnvVar').addEventListener('click', addPoolEnvVar);

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-env-var')) {
                e.target.closest('.env-var-row').remove();
            }
        });
        
        // Image config type radio buttons
        const imageConfigRadios = document.querySelectorAll('input[name="imageConfigType"]');
        imageConfigRadios.forEach(radio => {
            radio.addEventListener('change', toggleCustomImageOptions);
        });
        
        // Custom image type radio buttons
        const customImageTypeRadios = document.querySelectorAll('input[name="customImageType"]');
        customImageTypeRadios.forEach(radio => {
            radio.addEventListener('change', toggleCustomImageInputs);
        });
        
        // Form submissions
        document.getElementById('createUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            createUser();
        });
        
        document.getElementById('createPoolForm').addEventListener('submit', function(e) {
            e.preventDefault();
            createPool();
        });
    }

    function addPoolEnvVar() {
        const envVarsContainer = document.getElementById('poolEnvVars');
        const newRow = document.createElement('div');
        newRow.className = 'env-var-row';
        newRow.innerHTML = `
            <div class="flex-1">
                <input type="text" placeholder="Variable name (e.g., NODE_ENV)" 
                    class="w-full p-2 border border-gray-300 rounded-md env-var-name">
            </div>
            <div class="flex-1">
                <input type="text" placeholder="Variable value (e.g., development)" 
                    class="w-full p-2 border border-gray-300 rounded-md env-var-value">
            </div>
            <button type="button" class="remove-env-var bg-red-500 text-white py-2 px-3 rounded-md text-sm hover:bg-red-600">
                Remove
            </button>
        `;
        envVarsContainer.appendChild(newRow);
    }

    function collectPoolEnvVars() {
        const envVarRows = document.querySelectorAll('#poolEnvVars .env-var-row');
        const envVars = [];
        
        envVarRows.forEach(row => {
            const nameInput = row.querySelector('.env-var-name');
            const valueInput = row.querySelector('.env-var-value');
            
            if (nameInput.value.trim() && valueInput.value.trim()) {
                envVars.push({
                    name: nameInput.value.trim(),
                    value: valueInput.value.trim(),
                    masked: false  // New values are never masked
                });
            }
        });
        
        return envVars;
    }


    // Function to mark workspace as used
    async function markWorkspaceAsUsed(poolName, workspaceId) {
        const userInfo = prompt('Enter your name or identifier (optional):');
        
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/pools/${encodePoolName(poolName)}/workspaces/${workspaceId}/mark-used`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_info: userInfo || currentUser?.username || 'Unknown'
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                alert(`Workspace marked as used by ${data.user_info}`);
                loadPools(); // Refresh the pools list
            } else {
                alert(`Error: ${data.error || 'Failed to mark Pod as used'}`);
            }
        } catch (error) {
            console.error('Error marking Pod as used:', error);
            if (error.message !== 'Authentication required') {
                alert('Failed to mark Pod as used. Please try again later.');
            }
        }
    }

    // Function to mark workspace as unused
    async function markWorkspaceAsUnused(poolName, workspaceId) {
        if (!confirm('Mark this Pod as unused?')) return;
        
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/pools/${encodePoolName(poolName)}/workspaces/${workspaceId}/mark-unused`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                alert('Pod marked as unused');
                loadPools(); // Refresh the pools list
            } else {
                alert(`Error: ${data.error || 'Failed to mark Pod as unused'}`);
            }
        } catch (error) {
            console.error('Error marking Pod as unused:', error);
            if (error.message !== 'Authentication required') {
                alert('Failed to mark Pod as unused. Please try again later.');
            }
        }
    }

    // Helper function to get usage status badge
    function getUsageStatusBadge(usageStatus, userInfo) {
        if (usageStatus === 'used') {
            const user = userInfo ? ` by ${userInfo}` : '';
            return `<span class="text-xs px-2 py-1 rounded-full bg-orange-100 text-orange-800">Used${user}</span>`;
        } else {
            return `<span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">Available</span>`;
        }
    }

    // Add a new repository input
    function addRepositoryInput() {
        const repoInputs = document.getElementById('repoInputs');
        const newInput = document.createElement('div');
        newInput.className = 'repo-input';
        newInput.innerHTML = `
            <div class="w-full border border-gray-200 rounded-md p-3 mb-3">
                <div class="flex justify-between items-start mb-2">
                    <label for="githubUrl${repoCounter}" class="block text-gray-700 font-medium">Additional Repository URL</label>
                    <button type="button" class="remove-repo-btn bg-red-500 text-white py-1 px-3 rounded-md text-sm hover:bg-red-600">
                        Remove
                    </button>
                </div>
                <input type="text" id="githubUrl${repoCounter}" 
                    placeholder="https://github.com/username/repository" 
                    class="w-full p-2 border border-gray-300 rounded-md mb-2">
                <label for="githubBranch${repoCounter}" class="block text-gray-700 mb-2">Branch (optional)</label>
                <input type="text" id="githubBranch${repoCounter}" 
                    placeholder="main (leave empty for default branch)" 
                    class="w-full p-2 border border-gray-300 rounded-md">
                <p class="text-xs text-gray-500 mt-1">If not specified, the repository's default branch will be used</p>
            </div>
        `;
        repoInputs.appendChild(newInput);
        
        // Add event listener to remove button
        newInput.querySelector('.remove-repo-btn').addEventListener('click', function() {
            repoInputs.removeChild(newInput);
        });
        
        repoCounter++;
    }

    // Toggle custom image options visibility
    function toggleCustomImageOptions() {
        const customImageOptions = document.getElementById('customImageOptions');
        if (document.querySelector('input[name="imageConfigType"]:checked').value === 'custom') {
            customImageOptions.classList.remove('hidden');
        } else {
            customImageOptions.classList.add('hidden');
        }
    }

    // Toggle between Docker image name and URL inputs
    function toggleCustomImageInputs() {
        const imageNameInput = document.getElementById('customImageName');
        const imageUrlInput = document.getElementById('customImageUrl');
        
        if (document.querySelector('input[name="customImageType"]:checked').value === 'dockerImage') {
            imageNameInput.disabled = false;
            imageUrlInput.disabled = true;
        } else {
            imageNameInput.disabled = true;
            imageUrlInput.disabled = false;
        }
    }

    // Function to load workspaces
    async function loadWorkspaces() {
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/workspaces`);
            const data = await response.json();
            
            const workspacesList = document.getElementById('workspacesList');
            
            if (data.workspaces && data.workspaces.length > 0) {
                workspacesList.innerHTML = '';
                
                data.workspaces.forEach(workspace => {
                    const workspaceEl = document.createElement('div');
                    workspaceEl.className = 'border border-gray-200 rounded-md p-4';
                    
                    const repoName = workspace.repoName || (workspace.repositories?.[0] || workspace.repository).split('/').pop().replace('.git', '');
                    const stateBadge = getStateBadge(workspace.state || 'unknown');

                    // Create repository list HTML
                    let repoListHtml = '';
                    if (workspace.repositories && workspace.repositories.length > 0) {
                        repoListHtml = `
                            <div class="mt-2 border-t pt-2">
                                <p class="text-sm font-medium text-gray-700">Repositories:</p>
                                <ul class="text-sm text-gray-600 list-disc pl-5">
                        `;
                        
                        workspace.repositories.forEach((repo, index) => {
                            const repoShortName = repo.split('/').pop().replace('.git', '');
                            let branchInfo = '';
                            if (workspace.branches && workspace.branches[index]) {
                                branchInfo = ` <span class="text-xs text-blue-600">(${workspace.branches[index]})</span>`;
                            }
                            repoListHtml += `<li>${repoShortName}${branchInfo} <span class="text-xs text-gray-500">(${repo})</span></li>`;
                        });
                        
                        repoListHtml += `
                                </ul>
                            </div>
                        `;
                    } else if (workspace.repository) {
                        // For backward compatibility with old workspaces
                        let branchInfo = '';
                        if (workspace.branch) {
                            branchInfo = ` <span class="text-xs text-blue-600">(${workspace.branch})</span>`;
                        }
                        repoListHtml = `
                            <div class="mt-2">
                                <p class="text-sm text-gray-600">${workspace.repository}${branchInfo}</p>
                            </div>
                        `;
                    }
                    
                    // Add image info
                    let imageInfoHtml = '';
                    if (workspace.image) {
                        imageInfoHtml = `<p class="text-xs text-gray-500 mt-1">Image: ${workspace.image}</p>`;
                    } else if (workspace.imageUrl) {
                        imageInfoHtml = `<p class="text-xs text-gray-500 mt-1">Custom Image: Built from ${workspace.imageUrl}</p>`;
                    }
                    
                    workspaceEl.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center">
                                    <h3 class="font-semibold text-lg">${repoName}</h3>
                                    <span class="ml-2">${stateBadge}</span>
                                </div>
                                ${repoListHtml}
                                <p class="mt-1 text-xs text-gray-500">ID: ${workspace.id}</p>
                                <p class="mt-1 text-xs text-gray-500">Subdomain: ${workspace.fqdn}</p>
                                ${imageInfoHtml}
                                <p class="mt-2">
                                    <a href="${workspace.url}" target="_blank" class="text-blue-500 hover:underline">
                                        Open Pod
                                    </a>
                                </p>
                            </div>
                            <div class="space-x-2">
                                <button onclick="startWorkspace('${workspace.id}')" 
                                    class="bg-green-500 text-white py-1 px-3 rounded-md text-sm"
                                    ${workspace.state === 'running' ? 'disabled' : ''}>
                                    Start
                                </button>
                                <button onclick="stopWorkspace('${workspace.id}')"
                                    class="bg-yellow-500 text-white py-1 px-3 rounded-md text-sm"
                                    ${workspace.state !== 'running' ? 'disabled' : ''}>
                                    Stop
                                </button>
                                <button onclick="deleteWorkspace('${workspace.id}')" class="bg-red-500 text-white py-1 px-3 rounded-md text-sm">
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 text-sm">
                            <span class="text-gray-600">Created: ${new Date(workspace.created).toLocaleString()}</span>
                        </div>
                    `;
                    
                    workspacesList.appendChild(workspaceEl);
                });
            } else {
                workspacesList.innerHTML = '<p class="text-gray-500">No Pods found. Create one to get started.</p>';
            }
        } catch (error) {
            console.error('Error loading Pods:', error);
            if (error.message !== 'Authentication required') {
                document.getElementById('workspacesList').innerHTML = 
                    '<p class="text-red-500">Failed to load Pods. Please try again later.</p>';
            }
        }
    }

    // Function to load pools
    async function loadPools() {
        loadCapacity();

        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/pools`);
            const data = await response.json();
            
            const poolsList = document.getElementById('poolsList');
            
            if (data.pools && data.pools.length > 0) {
                poolsList.innerHTML = '';
                
                data.pools.forEach(pool => {
                    const poolEl = document.createElement('div');
                    poolEl.className = 'border border-gray-200 rounded-md p-4 bg-gray-50';
                    
                    const statusColor = pool.needs_scaling ? 'text-orange-600' : 'text-green-600';
                    const statusText = pool.needs_scaling ? `Scaling needed (${pool.scale_needed} more VMs)` : 'At minimum capacity';

                    let workspaces_info = "";
                    
                    if (pool.workspaces.length > 0) {
                        workspaces_info = `
                            <p><strong>Repository:</strong> ${pool.workspaces[0].primaryRepo || 'N/A'}</p>
                            <p><strong>Branch:</strong> ${pool.workspaces[0].branches[0] || 'N/A'}</p>
                        `;
                    } else {
                        console.log("Pool has no workspaces, check the logs...", pool)
                    }

                    let env_vars_info = '';
                    if (pool.config && pool.config.env_vars && pool.config.env_vars.length > 0) {
                        env_vars_info = `<p><strong>Environment Variables:</strong> ${pool.config.env_vars.length} configured</p>`;
                    }
                    
                    poolEl.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center">
                                    <h3 class="font-semibold text-lg">${pool.pool_name}</h3>
                                    <span class="ml-2 text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800">Pool</span>
                                </div>
                                <div class="mt-2 text-sm text-gray-600">
                                    ${workspaces_info}
                                    <p><strong>Minimum VMs:</strong> ${pool.minimum_vms}</p>
                                    <p><strong>Current VMs:</strong> ${pool.current_vms}</p>
                                    <p><strong>Running:</strong> ${pool.running_vms} | <strong>Pending:</strong> ${pool.pending_vms} | <strong>Failed:</strong> ${pool.failed_vms}</p>
                                    <p><strong>Used:</strong> ${pool.used_vms || 0} | <strong>Available:</strong> ${pool.unused_vms || 0}</p>
                                    ${env_vars_info}
                                    <p class="${statusColor}"><strong>Status:</strong> ${statusText}</p>
                                </div>
                                <div class="mt-2">
                                    <button onclick="togglePoolWorkspaces('${pool.pool_name}')" class="text-blue-500 hover:underline text-sm">
                                        View Pods (${pool.current_vms})
                                    </button>
                                </div>
                            </div>
                            <div class="space-x-2">
                                <button onclick="editPool('${pool.pool_name}')" 
                                    class="bg-blue-500 text-white py-1 px-3 rounded-md text-sm hover:bg-blue-600">
                                    Edit
                                </button>
                                <button onclick="scalePool('${pool.pool_name}')" class="bg-yellow-500 text-white py-1 px-3 rounded-md text-sm">
                                    Scale
                                </button>
                                <button onclick="deletePool('${pool.pool_name}')" class="bg-red-500 text-white py-1 px-3 rounded-md text-sm">
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 text-sm">
                            <span class="text-gray-600">Last Check: ${new Date(pool.last_check).toLocaleString()}</span>
                        </div>
                        <div id="pool-workspaces-${pool.pool_name.replace(/[^a-zA-Z0-9]/g, '-')}" class="hidden mt-4 border-t pt-4">
                            <!-- Workspaces will be loaded here -->
                        </div>
                    `;
                    
                    poolsList.appendChild(poolEl);
                });
            } else {
                poolsList.innerHTML = '<p class="text-gray-500">No pools found. Create one to get started.</p>';
            }
        } catch (error) {
            console.error('Error loading pools:', error);
            if (error.message !== 'Authentication required') {
                document.getElementById('poolsList').innerHTML = 
                    '<p class="text-red-500">Failed to load pools. Please try again later.</p>';
            }
        }
    }

    // Function to create a pool
    async function createPool() {
        const poolName = document.getElementById('poolName').value.trim();
        const minimumVms = parseInt(document.getElementById('minimumVms').value);
        const repoName = document.getElementById('poolRepoName').value.trim();
        const branchName = document.getElementById('poolBranchName').value.trim();
        const githubPat = document.getElementById('poolGithubPat').value.trim();
        const githubUsername = document.getElementById('poolGithubUsername').value.trim();
        const envVars = collectPoolEnvVars();
        
        if (!poolName || !repoName || !branchName) {
            alert('Please fill in all required fields');
            return;
        }

        if (poolName.includes('/') || poolName.includes(' ') || /[^a-zA-Z0-9_.-]/.test(poolName)) {
            alert('Pool name should not contain special characters.')
            return;
        }
        
        const statusEl = document.getElementById('createPoolStatus');
        statusEl.className = 'mt-4 p-4 bg-yellow-100 text-yellow-800 rounded-md';
        statusEl.innerHTML = 'Creating pool... This will start creating the minimum VMs.';
        statusEl.classList.remove('hidden');
        
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/pools`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    pool_name: poolName,
                    minimum_vms: minimumVms,
                    repo_name: repoName,
                    branch_name: branchName,
                    github_pat: githubPat,
                    github_username: githubUsername,
                    env_vars: envVars
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                statusEl.className = 'mt-4 p-4 bg-green-100 text-green-800 rounded-md';
                statusEl.innerHTML = `
                    <p class="font-semibold">Pool created successfully!</p>
                    <p>Pool Name: ${poolName}</p>
                    <p>Repository: ${repoName} (${branchName})</p>
                    <p>Minimum VMs: ${minimumVms}</p>
                    <p class="text-sm mt-2">The pool will automatically create and maintain the minimum number of pods.</p>
                `;
                
                // Reset form
                document.getElementById('createPoolForm').reset();
                document.getElementById('minimumVms').value = '1';
                document.getElementById('poolBranchName').value = 'master';
                document.getElementById('poolGithubUsername').value = '';

                // Clear environment variables
                const envVarsContainer = document.getElementById('poolEnvVars');
                envVarsContainer.innerHTML = `
                    <div class="env-var-row">
                        <div class="flex-1">
                            <input type="text" placeholder="Variable name (e.g., NODE_ENV)" 
                                class="w-full p-2 border border-gray-300 rounded-md env-var-name">
                        </div>
                        <div class="flex-1">
                            <input type="text" placeholder="Variable value (e.g., development)" 
                                class="w-full p-2 border border-gray-300 rounded-md env-var-value">
                        </div>
                        <button type="button" class="remove-env-var bg-red-500 text-white py-2 px-3 rounded-md text-sm hover:bg-red-600">
                            Remove
                        </button>
                    </div>
                `;
                
                // Reload pools
                loadPools();
            } else {
                statusEl.className = 'mt-4 p-4 bg-red-100 text-red-800 rounded-md';
                statusEl.innerHTML = `<p>Error: ${data.error || 'Failed to create pool'}</p>`;
            }
        } catch (error) {
            console.error('Error creating pool:', error);
            if (error.message !== 'Authentication required') {
                statusEl.className = 'mt-4 p-4 bg-red-100 text-red-800 rounded-md';
                statusEl.innerHTML = '<p>Failed to create pool. Please try again later.</p>';
            }
        }
    }

    async function editPool(poolName) {
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/pools/${encodePoolName(poolName)}`);
            const data = await response.json();
            
            if (response.ok && data.config) {
                showEditPoolModal(data.config);
            } else {
                alert(`Error: ${data.error || 'Failed to load pool configuration'}`);
            }
        } catch (error) {
            console.error('Error loading pool for edit:', error);
            if (error.message !== 'Authentication required') {
                alert('Failed to load pool configuration. Please try again later.');
            }
        }
    }

    function showEditPoolModal(poolConfig) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        modal.id = 'editPoolModal';
        
        // Handle GitHub PAT display
        let githubPatValue = '';
        let githubPatMasked = false;
        if (typeof poolConfig.github_pat === 'object' && poolConfig.github_pat) {
            githubPatValue = poolConfig.github_pat.value || '';
            githubPatMasked = poolConfig.github_pat.masked || false;
        } else if (typeof poolConfig.github_pat === 'string') {
            githubPatValue = poolConfig.github_pat;
            githubPatMasked = false;
        }
        
        const githubPatPlaceholder = githubPatMasked ? 'Leave unchanged or enter new token' : 'GitHub Personal Access Token';
        const githubPatClass = githubPatMasked ? 'masked-input' : '';
        
        let envVarsHtml = '';
        if (poolConfig.env_vars && poolConfig.env_vars.length > 0) {
            poolConfig.env_vars.forEach((envVar, index) => {
                const isMasked = envVar.masked || false;
                const placeholder = isMasked ? 'Leave unchanged or enter new value' : 'Variable value';
                const valueClass = isMasked ? 'masked-input' : '';
                
                envVarsHtml += `
                    <div class="env-var-row" data-original-masked="${isMasked}">
                        <div class="flex-1">
                            <input type="text" value="${envVar.name}" 
                                class="w-full p-2 border border-gray-300 rounded-md env-var-name"
                                ${isMasked ? 'readonly' : ''}>
                        </div>
                        <div class="flex-1">
                            <input type="text" value="${envVar.value}" 
                                placeholder="${placeholder}"
                                class="w-full p-2 border border-gray-300 rounded-md env-var-value ${valueClass}"
                                data-original-value="${envVar.value}"
                                data-masked="${isMasked}">
                            ${isMasked ? '<p class="text-xs text-gray-500 mt-1">Showing masked value - modify to change</p>' : ''}
                        </div>
                        <button type="button" class="remove-env-var bg-red-500 text-white py-2 px-3 rounded-md text-sm hover:bg-red-600">
                            Remove
                        </button>
                    </div>
                `;
            });
        } else {
            envVarsHtml = `
                <div class="env-var-row">
                    <div class="flex-1">
                        <input type="text" placeholder="Variable name (e.g., NODE_ENV)" 
                            class="w-full p-2 border border-gray-300 rounded-md env-var-name">
                    </div>
                    <div class="flex-1">
                        <input type="text" placeholder="Variable value (e.g., development)" 
                            class="w-full p-2 border border-gray-300 rounded-md env-var-value">
                    </div>
                    <button type="button" class="remove-env-var bg-red-500 text-white py-2 px-3 rounded-md text-sm hover:bg-red-600">
                        Remove
                    </button>
                </div>
            `;
        }
        
        modal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-4/5 max-w-4xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Edit Pool: ${poolConfig.pool_name}</h3>
                    <form id="editPoolForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-gray-700 mb-2">Minimum VMs</label>
                                <input type="number" id="editMinimumVms" min="1" value="${poolConfig.minimum_vms}"
                                    class="w-full p-2 border border-gray-300 rounded-md" required>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">GitHub Username</label>
                                <input type="text" id="editGithubUsername" value="${poolConfig.github_username || ''}"
                                    class="w-full p-2 border border-gray-300 rounded-md">
                            </div>
                        </div>
                        
                        <!-- GitHub PAT Section -->
                        <div class="mb-6">
                            <label class="block text-gray-700 mb-2">GitHub Personal Access Token</label>
                            <input type="password" id="editGithubPat" 
                                value="${githubPatValue}"
                                placeholder="${githubPatPlaceholder}"
                                class="w-full p-2 border border-gray-300 rounded-md ${githubPatClass}"
                                data-original-value="${githubPatValue}"
                                data-masked="${githubPatMasked}">
                            ${githubPatMasked ? '<p class="text-xs text-gray-500 mt-1">Showing masked token - modify to change</p>' : ''}
                            <p class="text-xs text-gray-500 mt-1">
                                <span class="text-red-500">Required for private repositories.</span> 
                                Create a token with <b>repo</b> access.
                            </p>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="text-md font-medium mb-3">Environment Variables</h4>
                            <div class="mb-2 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                                <p class="text-sm text-yellow-800">
                                    <strong>Note:</strong> Existing values are masked for security. 
                                    Leave them unchanged to keep current values, or modify to update them.
                                </p>
                            </div>
                            <div id="editPoolEnvVars" class="space-y-2 mb-4">
                                ${envVarsHtml}
                            </div>
                            <button type="button" id="addEditPoolEnvVar" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300">
                                + Add Environment Variable
                            </button>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <button type="button" onclick="closeEditPoolModal()" class="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                                Cancel
                            </button>
                            <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">
                                Update Pool
                            </button>
                        </div>
                    </form>
                    <div id="editPoolStatus" class="mt-4 hidden"></div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Add event listeners (same as before)
        document.getElementById('addEditPoolEnvVar').addEventListener('click', function() {
            const envVarsContainer = document.getElementById('editPoolEnvVars');
            const newRow = document.createElement('div');
            newRow.className = 'env-var-row';
            newRow.innerHTML = `
                <div class="flex-1">
                    <input type="text" placeholder="Variable name (e.g., NODE_ENV)" 
                        class="w-full p-2 border border-gray-300 rounded-md env-var-name">
                </div>
                <div class="flex-1">
                    <input type="text" placeholder="Variable value (e.g., development)" 
                        class="w-full p-2 border border-gray-300 rounded-md env-var-value">
                </div>
                <button type="button" class="remove-env-var bg-red-500 text-white py-2 px-3 rounded-md text-sm hover:bg-red-600">
                    Remove
                </button>
            `;
            envVarsContainer.appendChild(newRow);
        });
        
        // Add styling for masked inputs
        const style = document.createElement('style');
        style.textContent = `
            .masked-input {
                background-color: #f9f9f9;
                font-family: monospace;
                letter-spacing: 1px;
            }
            .masked-input:focus {
                background-color: white;
            }
        `;
        document.head.appendChild(style);
        
        document.getElementById('editPoolForm').addEventListener('submit', function(e) {
            e.preventDefault();
            updatePool(poolConfig.pool_name);
        });
        
        // Handle remove buttons
        modal.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-env-var')) {
                e.target.closest('.env-var-row').remove();
            }
        });
    }


    function closeEditPoolModal() {
        const modal = document.getElementById('editPoolModal');
        if (modal) {
            modal.remove();
        }
    }

    async function updatePool(poolName) {
        const minimumVms = parseInt(document.getElementById('editMinimumVms').value);
        const githubUsername = document.getElementById('editGithubUsername').value.trim();
        
        // Handle GitHub PAT with masking awareness
        const githubPatInput = document.getElementById('editGithubPat');
        const originalPatValue = githubPatInput.dataset.originalValue;
        const currentPatValue = githubPatInput.value.trim();
        const patWasMasked = githubPatInput.dataset.masked === 'true';
        
        // Determine if the PAT was changed
        const patChanged = patWasMasked ? (currentPatValue !== originalPatValue) : true;
        
        const githubPat = {
            value: currentPatValue,
            masked: patWasMasked && !patChanged  // Keep masked flag if unchanged
        };
        
        // Collect environment variables with masking awareness
        const envVarRows = document.querySelectorAll('#editPoolEnvVars .env-var-row');
        const envVars = [];
        
        envVarRows.forEach(row => {
            const nameInput = row.querySelector('.env-var-name');
            const valueInput = row.querySelector('.env-var-value');
            
            if (nameInput.value.trim()) {
                const originalValue = valueInput.dataset.originalValue;
                const currentValue = valueInput.value.trim();
                const wasMasked = valueInput.dataset.masked === 'true';
                
                // Determine if the value was changed
                const valueChanged = wasMasked ? (currentValue !== originalValue) : true;
                
                envVars.push({
                    name: nameInput.value.trim(),
                    value: currentValue,
                    masked: wasMasked && !valueChanged  // Keep masked flag if unchanged
                });
            }
        });
        
        const statusEl = document.getElementById('editPoolStatus');
        statusEl.className = 'mt-4 p-4 bg-yellow-100 text-yellow-800 rounded-md';
        statusEl.innerHTML = 'Updating pool...';
        statusEl.classList.remove('hidden');
        
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/pools/${encodePoolName(poolName)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    minimum_vms: minimumVms,
                    github_username: githubUsername,
                    github_pat: githubPat,  // Send PAT object with masking info
                    env_vars: envVars
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                statusEl.className = 'mt-4 p-4 bg-green-100 text-green-800 rounded-md';
                
                // Count changed vs unchanged items
                const changedVars = envVars.filter(env => !env.masked).length;
                const unchangedVars = envVars.filter(env => env.masked).length;
                const patStatus = githubPat.masked ? 'unchanged' : 'updated';
                
                let updateSummary = `GitHub PAT: ${patStatus}`;
                if (envVars.length > 0) {
                    updateSummary += `<br>Environment Variables: ${envVars.length} total`;
                    if (changedVars > 0 && unchangedVars > 0) {
                        updateSummary += ` (${changedVars} updated, ${unchangedVars} unchanged)`;
                    } else if (unchangedVars > 0) {
                        updateSummary += ` (all unchanged)`;
                    }
                }
                
                statusEl.innerHTML = `
                    <p class="font-semibold">Pool updated successfully!</p>
                    <p>${updateSummary}</p>
                `;
                
                // Reload pools and close modal after a delay
                setTimeout(() => {
                    closeEditPoolModal();
                    loadPools();
                }, 1500);
            } else {
                statusEl.className = 'mt-4 p-4 bg-red-100 text-red-800 rounded-md';
                statusEl.innerHTML = `<p>Error: ${data.error || 'Failed to update pool'}</p>`;
            }
        } catch (error) {
            console.error('Error updating pool:', error);
            if (error.message !== 'Authentication required') {
                statusEl.className = 'mt-4 p-4 bg-red-100 text-red-800 rounded-md';
                statusEl.innerHTML = '<p>Failed to update pool. Please try again later.</p>';
            }
        }
    }


    // Function to toggle pool workspaces visibility
    async function togglePoolWorkspaces(poolName) {
        const workspacesEl = document.getElementById(`pool-workspaces-${poolName.replace(/[^a-zA-Z0-9]/g, '-')}`);
        
        if (workspacesEl.classList.contains('hidden')) {
            // Load and show workspaces
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/pools/${encodePoolName(poolName)}/workspaces`);
                const data = await response.json();
                
                if (response.ok && data.workspaces) {
                    let workspacesHtml = '<h4 class="font-medium text-gray-700 mb-2">Pool Pods:</h4>';
                    
                    if (data.workspaces.length > 0) {
                        workspacesHtml += '<div class="grid grid-cols-1 lg:grid-cols-2 gap-3">';
                        data.workspaces.forEach(workspace => {
                            const stateBadge = getStateBadge(workspace.state || 'unknown');
                            const usageBadge = getUsageStatusBadge(workspace.usage_status, workspace.user_info);
                            
                            const isRunning = workspace.state === 'running';
                            const isUsed = workspace.usage_status === 'used';
                            
                            workspacesHtml += `
                                <div class="border rounded p-3 text-sm bg-white">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-medium text-xs">${workspace.id}</span>
                                        <div class="flex flex-col space-y-1">
                                            ${stateBadge}
                                            ${usageBadge}
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-500 mb-2">
                                        <a href="${workspace.url}" target="_blank" class="text-blue-500 hover:underline">Open Pod</a>
                                        <br/>
                                        <a href="https://us-east-1.console.aws.amazon.com/cloudwatch/home?region=us-east-1#logsV2:log-groups/log-group/$252Faws$252Fcontainerinsights$252Fworkspace-cluster$252Fapplication$3FlogStreamNameFilter$3D${workspace.id}" target="_blank" class="text-blue-500 hover:underline">
                                            See AWS Logs
                                        </a>
                                    </div>
                                    <div class="text-xs text-gray-400 mb-2">Password: ${workspace.password}</div>
                                    ${workspace.marked_at ? `<div class="text-xs text-gray-400 mb-2">Marked: ${new Date(workspace.marked_at).toLocaleString()}</div>` : ''}
                                    <div class="flex space-x-1">
                                        <button onclick="markWorkspaceAsUsed('${poolName}', '${workspace.id}')" 
                                            class="text-xs py-1 px-2 rounded ${!isRunning || isUsed ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-green-500 text-white hover:bg-green-600'}"
                                            ${!isRunning || isUsed ? 'disabled' : ''}>
                                            Mark Used
                                        </button>
                                        <button onclick="markWorkspaceAsUnused('${poolName}', '${workspace.id}')" 
                                            class="text-xs py-1 px-2 rounded ${!isRunning || !isUsed ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-green-500 text-white hover:bg-green-600'}"
                                            ${!isRunning || !isUsed ? 'disabled' : ''}>
                                            Mark Unused
                                        </button>
                                        <button onclick="deletePoolWorkspace('${poolName}', '${workspace.id}')" 
                                            class="text-xs py-1 px-2 rounded bg-red-500 text-white hover:bg-red-600">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        workspacesHtml += '</div>';
                    } else {
                        workspacesHtml += '<p class="text-gray-500 text-sm">No Pods in this pool yet.</p>';
                    }
                    
                    workspacesEl.innerHTML = workspacesHtml;
                }
                
                workspacesEl.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading pool pods:', error);
                workspacesEl.innerHTML = '<p class="text-red-500 text-sm">Failed to load Pods.</p>';
                workspacesEl.classList.remove('hidden');
            }
        } else {
            // Hide workspaces
            workspacesEl.classList.add('hidden');
        }
    }

    async function deletePoolWorkspace(poolName, workspaceId) {
        if (!confirm(`Are you sure you want to delete Pod "${workspaceId}" from pool "${poolName}"? This action cannot be undone.`)) {
            return;
        }
        
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/pools/${encodePoolName(poolName)}/workspaces/${workspaceId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                alert(`Pod "${workspaceId}" deleted successfully`);
                // Refresh both the pools list and the expanded workspaces view
                loadPools();
                // Re-expand the pool workspaces if they were visible
                setTimeout(() => {
                    const workspacesEl = document.getElementById(`pool-workspaces-${poolName.replace(/[^a-zA-Z0-9]/g, '-')}`);
                    if (workspacesEl && !workspacesEl.classList.contains('hidden')) {
                        togglePoolWorkspaces(poolName);
                        setTimeout(() => togglePoolWorkspaces(poolName), 100);
                    }
                }, 500);
            } else {
                alert(`Error: ${data.error || 'Failed to delete Pod'}`);
            }
        } catch (error) {
            console.error('Error deleting Pod from pool:', error);
            if (error.message !== 'Authentication required') {
                alert('Failed to delete Pod. Please try again later.');
            }
        }
    }


    // Function to get an available workspace from pool
    async function getAvailableWorkspace(poolName) {
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/pools/${encodePoolName(poolName)}/workspace`);
            const data = await response.json();
            
            if (response.ok && data.success && data.workspace) {
                const workspace = data.workspace;
                const message = `Available Pod found!\n\nID: ${workspace.id}\nURL: ${workspace.url}\nState: ${workspace.state}\n\nOpen Pod now?`;
                
                if (confirm(message)) {
                    window.open(workspace.url, '_blank');
                }
            } else {
                alert('No available Pod in pool at the moment. Please try again later.');
            }
        } catch (error) {
            console.error('Error getting available Pod:', error);
            if (error.message !== 'Authentication required') {
                alert('Failed to get available Pod. Please try again later.');
            }
        }
    }

    // Function to scale a pool
    async function scalePool(poolName) {
        const newMinimum = prompt('Enter new minimum VMs:');
        if (!newMinimum || isNaN(newMinimum) || parseInt(newMinimum) < 1) {
            return;
        }
        
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/pools/${encodePoolName(poolName)}/scale`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    minimum_vms: parseInt(newMinimum)
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                alert(data.message);
                loadPools();
            } else {
                alert(`Error: ${data.error || 'Failed to scale pool'}`);
            }
        } catch (error) {
            console.error('Error scaling pool:', error);
            if (error.message !== 'Authentication required') {
                alert('Failed to scale pool. Please try again later.');
            }
        }
    }

    // Function to delete a pool
    async function deletePool(poolName) {
        if (!confirm(`Are you sure you want to delete pool "${poolName}"? This will delete all Pods in the pool. This action cannot be undone.`)) {
            return;
        }
        
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/pools/${encodePoolName(poolName)}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                alert(data.message);
                loadPools();
            } else {
                alert(`Error: ${data.error || 'Failed to delete pool'}`);
            }
        } catch (error) {
            console.error('Error deleting pool:', error);
            if (error.message !== 'Authentication required') {
                alert('Failed to delete pool. Please try again later.');
            }
        }
    }

    // Function to create a workspace
    async function createWorkspace() {
        const repoInputs = document.querySelectorAll('#repoInputs .repo-input');

        let repositories = [];
        let branches = [];
        
        for (let i = 0; i < repoInputs.length; i++) {
            const urlInput = repoInputs[i].querySelector('input[id^="githubUrl"]');
            const branchInput = repoInputs[i].querySelector('input[id^="githubBranch"]');
            
            const url = urlInput ? urlInput.value.trim() : '';
            const branch = branchInput ? branchInput.value.trim() : '';
            
            if (url) {
                repositories.push(url);
                branches.push(branch || ''); // Empty string for default branch
            }
        }

        if (repositories.length === 0) {
            alert('Please enter at least one GitHub repository URL');
            return;
        }

        const githubPat = document.getElementById('githubPat').value.trim();
        
        let requestData = {
            githubUrls: repositories,
            githubBranches: branches
        };

        if (githubPat) {
            requestData.githubToken = githubPat;
        }

        const githubUsername = document.getElementById('githubUsername').value.trim();

        if (githubUsername) {
            requestData.githubUsername = githubUsername;
        }
        
        // Get image configuration
        const imageConfigType = document.querySelector('input[name="imageConfigType"]:checked').value;
        
        if (imageConfigType === 'custom') {
            const customImageType = document.querySelector('input[name="customImageType"]:checked').value;
            
            if (customImageType === 'dockerImage') {
                const customImage = document.getElementById('customImageName').value.trim();
                if (customImage) {
                    requestData.image = customImage;
                }
            } else {
                const imageUrl = document.getElementById('customImageUrl').value.trim();
                if (imageUrl) {
                    requestData.imageUrl = imageUrl;
                }
            }
        }
        
        const statusEl = document.getElementById('createStatus');
        statusEl.className = 'mt-4 p-4 bg-yellow-100 text-yellow-800 rounded-md';
        statusEl.innerHTML = 'Creating Pod... This may take a few minutes.';
        statusEl.classList.remove('hidden');
        
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/workspaces`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            if (response.ok) {
                if (data.success) {
                    statusEl.className = 'mt-4 p-4 bg-green-100 text-green-800 rounded-md';
                    
                    const workspace = data.workspace;
                    
                    // Create repository list HTML for the status message
                    let repoListHtml = '';
                    if (workspace.repositories && workspace.repositories.length > 0) {
                        repoListHtml = `
                            <div class="mt-2">
                                <p class="font-medium">Repositories:</p>
                                <ul class="list-disc pl-5">
                        `;
                        
                        workspace.repositories.forEach((repo, index) => {
                            const lastSegment = repo.replace(/\/+$/, '').split('/').pop() || '';
                            const repoShortName = lastSegment.replace('.git', '').replace(/^\/+/, '');
                            const displayName = repoShortName || 'repository';
                            
                            let branchInfo = '';
                            if (workspace.branches && workspace.branches[index]) {
                                branchInfo = ` (${workspace.branches[index]})`;
                            }
                            
                            repoListHtml += `<li>${displayName}${branchInfo}</li>`;
                        });
                        
                        repoListHtml += `
                                </ul>
                            </div>
                        `;
                    }
                    
                    // Add image info
                    let imageInfoHtml = '';
                    if (workspace.image) {
                        imageInfoHtml = `<p class="text-sm">Image: ${workspace.image}</p>`;
                    } else if (workspace.imageUrl) {
                        imageInfoHtml = `<p class="text-sm">Custom Image: Building from ${workspace.imageUrl}</p>`;
                    }
                    
                    statusEl.innerHTML = `
                        <p class="font-semibold">Pod creation initiated!</p>
                        ${repoListHtml}
                        ${imageInfoHtml}
                        <p class="mt-2">
                            <a href="${workspace.url}" target="_blank" class="text-blue-600 hover:underline">Open Pod</a>
                        </p>
                        <p class="text-xs text-gray-500">Subdomain: ${workspace.fqdn}</p>
                        <p class="mt-1">Password: <code class="bg-gray-100 px-2 py-1 rounded">${workspace.password}</code></p>
                        <p class="text-xs mt-2">Please note: It may take a few minutes for the workspace to be fully ready.</p>
                        <p class="text-xs mt-1">If you're building a custom image, it may take even longer for the first startup.</p>
                    `;
                    
                    // Reset the form
                    document.getElementById('repoInputs').innerHTML = `
                        <div class="repo-input">
                            <div class="w-full">
                                <label for="githubUrl0" class="block text-gray-700 mb-2">GitHub Repository URL</label>
                                <input type="text" id="githubUrl0" 
                                    placeholder="https://github.com/username/repository" 
                                    class="w-full p-2 border border-gray-300 rounded-md mb-2">
                                <label for="githubBranch0" class="block text-gray-700 mb-2">Branch (optional)</label>
                                <input type="text" id="githubBranch0" 
                                    placeholder="main (leave empty for default branch)" 
                                    class="w-full p-2 border border-gray-300 rounded-md">
                                <p class="text-xs text-gray-500 mt-1">If not specified, the repository's default branch will be used</p>
                            </div>
                        </div>
                    `;
                    repoCounter = 1;
                    toggleCustomImageOptions();
                    
                    // Reload the workspaces list
                    loadWorkspaces();
                } else {
                    statusEl.className = 'mt-4 p-4 bg-blue-100 text-blue-800 rounded-md';
                    statusEl.innerHTML = `<p>${data.message}</p>`;
                    loadWorkspaces();
                }
            } else {
                statusEl.className = 'mt-4 p-4 bg-red-100 text-red-800 rounded-md';
                statusEl.innerHTML = `<p>Error: ${data.error || 'Something went wrong'}</p>`;
            }
        } catch (error) {
            console.error('Error creating workspace:', error);
            if (error.message !== 'Authentication required') {
                statusEl.className = 'mt-4 p-4 bg-red-100 text-red-800 rounded-md';
                statusEl.innerHTML = '<p>Failed to create workspace. Please try again later.</p>';
            }
        }
    }

    // Function to start a workspace
    async function startWorkspace(id) {
        if (!confirm('Start this workspace?')) return;
        
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/workspaces/${id}/start`, {
                method: 'POST'
            });
            
            if (response.ok) {
                const data = await response.json();
                alert(data.message || 'Workspace starting');
                loadWorkspaces();
            } else {
                const data = await response.json();
                alert(`Error: ${data.error || 'Failed to start workspace'}`);
            }
        } catch (error) {
            console.error('Error starting workspace:', error);
            if (error.message !== 'Authentication required') {
                alert('Failed to start workspace. Please try again later.');
            }
        }
    }

    // Function to stop a workspace
    async function stopWorkspace(id) {
        if (!confirm('Stop this Pod?')) return;
        
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/workspaces/${id}/stop`, {
                method: 'POST'
            });
            
            if (response.ok) {
                const data = await response.json();
                alert(data.message || 'Workspace stopping');
                loadWorkspaces();
            } else {
                const data = await response.json();
                alert(`Error: ${data.error || 'Failed to stop Pod'}`);
            }
        } catch (error) {
            console.error('Error stopping Pod:', error);
            if (error.message !== 'Authentication required') {
                alert('Failed to stop Pod. Please try again later.');
            }
        }
    }

    // Function to delete a workspace
    async function deleteWorkspace(id) {
        if (!confirm('Are you sure you want to delete this Pod? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/workspaces/${id}/delete`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                const data = await response.json();
                alert(data.message || 'Pod deleted');
                loadWorkspaces();
            } else {
                const data = await response.json();
                alert(`Error: ${data.error || 'Failed to delete Pod'}`);
            }
        } catch (error) {
            console.error('Error deleting Pod:', error);
            if (error.message !== 'Authentication required') {
                alert('Failed to delete Pod. Please try again later.');
            }
        }
    }

    async function loadUsers() {
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/users`);
            const data = await response.json();
            
            const usersList = document.getElementById('usersList');
            
            if (data.users && data.users.length > 0) {
                usersList.innerHTML = '';
                
                data.users.forEach(user => {
                    const userEl = document.createElement('div');
                    userEl.className = 'border border-gray-200 rounded-md p-4';
                    
                    const statusBadge = user.is_active ? 
                        '<span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">Active</span>' :
                        '<span class="text-xs px-2 py-1 rounded-full bg-red-100 text-red-800">Inactive</span>';
                    
                    userEl.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center">
                                    <h3 class="font-semibold text-lg">${user.username}</h3>
                                    <span class="ml-2">${statusBadge}</span>
                                </div>
                                <p class="text-sm text-gray-600 mt-1">Email: ${user.email}</p>
                                <p class="text-sm text-gray-600">Pools: ${user.pool_count}</p>
                                <p class="text-sm text-gray-600">Token: ${user.authentication_token}</p>
                                <p class="text-sm text-gray-600">Created: ${new Date(user.created_at).toLocaleString()}</p>
                                ${user.last_login ? `<p class="text-sm text-gray-600">Last Login: ${new Date(user.last_login).toLocaleString()}</p>` : ''}
                            </div>
                            <div class="space-x-2">
                                <button onclick="deleteUser('${user.username}')" 
                                    class="bg-red-500 text-white py-1 px-3 rounded-md text-sm hover:bg-red-600"
                                    ${user.username === currentUser?.username ? 'disabled title="Cannot delete yourself"' : ''}>
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                    
                    usersList.appendChild(userEl);
                });
            } else {
                usersList.innerHTML = '<p class="text-gray-500">No users found.</p>';
            }
        } catch (error) {
            console.error('Error loading users:', error);
            if (error.message !== 'Authentication required') {
                document.getElementById('usersList').innerHTML = 
                    '<p class="text-red-500">Failed to load users. Please try again later.</p>';
            }
        }
    }

    // Function to create a user
    async function createUser() {
        const username = document.getElementById('newUsername').value.trim();
        const email = document.getElementById('newEmail').value.trim();
        const password = document.getElementById('newPassword').value;
        
        if (!username || !email || !password) {
            alert('Please fill in all required fields');
            return;
        }
        
        if (password.length < 6) {
            alert('Password must be at least 6 characters long');
            return;
        }
        
        const statusEl = document.getElementById('createUserStatus');
        statusEl.className = 'mt-4 p-4 bg-yellow-100 text-yellow-800 rounded-md';
        statusEl.innerHTML = 'Creating user...';
        statusEl.classList.remove('hidden');
        
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/users`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    email: email,
                    password: password
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                statusEl.className = 'mt-4 p-4 bg-green-100 text-green-800 rounded-md';
                statusEl.innerHTML = `
                    <p class="font-semibold">User created successfully!</p>
                    <p>Username: ${username}</p>
                    <p>Email: ${email}</p>
                `;
                
                // Reset form
                document.getElementById('createUserForm').reset();
                
                // Reload users
                loadUsers();
            } else {
                statusEl.className = 'mt-4 p-4 bg-red-100 text-red-800 rounded-md';
                statusEl.innerHTML = `<p>Error: ${data.error || 'Failed to create user'}</p>`;
            }
        } catch (error) {
            console.error('Error creating user:', error);
            if (error.message !== 'Authentication required') {
                statusEl.className = 'mt-4 p-4 bg-red-100 text-red-800 rounded-md';
                statusEl.innerHTML = '<p>Failed to create user. Please try again later.</p>';
            }
        }
    }

    // Function to delete a user
    async function deleteUser(username) {
        if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
            return;
        }
        
        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/users/${username}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                alert(`User "${username}" deleted successfully`);
                loadUsers();
            } else {
                alert(`Error: ${data.error || 'Failed to delete user'}`);
            }
        } catch (error) {
            console.error('Error deleting user:', error);
            if (error.message !== 'Authentication required') {
                alert('Failed to delete user. Please try again later.');
            }
        }
    }


    // Helper function to get a state badge
    function getStateBadge(state) {
        const stateColors = {
            'running': 'bg-green-100 text-green-800',
            'pending': 'bg-yellow-100 text-yellow-800',
            'terminating': 'bg-orange-100 text-orange-800',
            'failed': 'bg-red-100 text-red-800',
            'unknown': 'bg-gray-100 text-gray-800'
        };
        
        const color = stateColors[state] || stateColors.unknown;
        return `<span class="text-xs px-2 py-1 rounded-full ${color}">${state}</span>`;
    }
    </script>
</body>
</html>